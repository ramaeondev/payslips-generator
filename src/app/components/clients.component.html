<div class="min-h-screen bg-gray-50">
  <header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-lg font-bold">Clients</h1>
      <div class="flex items-center gap-2">
        <button (click)="openNew = true" class="px-3 py-1 text-sm bg-green-600 text-white rounded">New Client</button>
        <button routerLink="/settings" class="px-3 py-1 text-sm border rounded">Back to Settings</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4">
    <!-- Clients Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <app-client-card *ngFor="let c of clients()" [client]="c" (edit)="editClient($event)"
        (requestDelete)="promptDeleteClient($event)"></app-client-card>
    </div>

    <!-- Global confirmation overlays (always available) -->
    @if (pendingDeleteClientId) {
    <div class="fixed inset-0 bg-black/30 flex items-center justify-center z-50">
      <div class="bg-white p-4 rounded shadow w-96">
        <div class="font-semibold mb-2">Delete client</div>
        <div class="text-sm text-gray-700 mb-4">Are you sure you want to delete this client and all its assets? This action cannot be undone.</div>
        <div class="flex justify-end gap-2">
          <button (click)="pendingDeleteClientId = null" class="px-3 py-1">Cancel</button>
          <button (click)="confirmDeleteClient()" class="px-3 py-1 bg-red-600 text-white rounded">Delete</button>
        </div>
      </div>
    </div>
    }

    @if (pendingDeleteAssetId) {
    <div class="fixed inset-0 bg-black/30 flex items-center justify-center z-50">
      <div class="bg-white p-4 rounded shadow w-96">
        <div class="font-semibold mb-2">Delete asset</div>
        <div class="text-sm text-gray-700 mb-4">Delete this asset for the client?</div>
        <div class="flex justify-end gap-2">
          <button (click)="pendingDeleteAssetId = null" class="px-3 py-1">Cancel</button>
          <button (click)="confirmDeleteAsset()" class="px-3 py-1 bg-red-600 text-white rounded">Delete</button>
        </div>
      </div>
    </div>
    }

    @if (pendingCancelCreate) {
    <div class="fixed inset-0 bg-black/30 flex items-center justify-center z-50">
      <div class="bg-white p-4 rounded shadow w-96">
        <div class="font-semibold mb-2">Cancel creation</div>
        <div class="text-sm text-gray-700 mb-4">Canceling will delete the newly-created client. Proceed?</div>
        <div class="flex justify-end gap-2">
          <button (click)="pendingCancelCreate = false" class="px-3 py-1">Back</button>
          <button (click)="confirmCancelCreateFlow()" class="px-3 py-1 bg-red-600 text-white rounded">Confirm</button>
        </div>
      </div>
    </div>
    }

    <!-- New Client Modal (Two-step) -->
    @if (openNew) {
    <div class="fixed inset-0 bg-black/40 flex items-center justify-center">
      <div class="bg-white rounded-lg p-6 w-[720px] overflow-auto max-h-[80vh]">
        <div class="flex justify-between items-center mb-4">
          <h2 class="font-semibold">Create Client</h2>
          <div class="text-sm text-gray-500">Step {{ newStep }} of 2</div>
        </div>



        <!-- Step 1: Details -->
        @if (newStep === 1) {
        <div class="grid grid-cols-2 gap-3 mb-3">
          <input [(ngModel)]="newName" placeholder="Client name" class="w-full p-2 border rounded" />
          <input [(ngModel)]="newEmail" placeholder="Contact email" class="w-full p-2 border rounded" />
        </div>
        <input [(ngModel)]="newAddress" placeholder="Address" class="w-full p-2 border rounded mb-3" />

        <div class="grid grid-cols-2 gap-2 mb-3">
          <input [(ngModel)]="newCity" placeholder="City" class="p-2 border rounded" />
          <input [(ngModel)]="newState" placeholder="State" class="p-2 border rounded" />
          <input [(ngModel)]="newPostalCode" placeholder="Postal Code" class="p-2 border rounded" />
          <input [(ngModel)]="newWebsite" placeholder="Website" class="p-2 border rounded" />
        </div>

        @if (newError) { <div class="mb-3 p-2 bg-red-50 text-red-700 rounded text-sm">{{ newError }}</div> }

        <div class="flex justify-end gap-2">
          <button (click)="openNew = false" class="px-3 py-1">Cancel</button>
          <button (click)="createClientStep1()" [disabled]="creatingClient"
            class="px-3 py-1 bg-blue-600 text-white rounded">
            @if (creatingClient) { <span>Creating...</span> } @else { <span>Next: Attach Files</span> }
          </button>
        </div>
        }

        <!-- Step 2: Attachments -->
        @if (newStep === 2) {
        <div class="mb-3">
          <div class="text-sm text-gray-700">Client: <span class="font-semibold">{{ createdClient?.name }}</span></div>
          <div class="text-xs text-gray-500">ID: {{ createdClient?.id }}</div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium mb-1">Logo</label>
            <input type="file" (change)="onNewClientFile($event, 'logo')" accept="image/*" />
            @if (newLogoFile) {
            <div class="mt-2 text-xs">Selected: {{ newLogoFile.name }}</div>
            }
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Header</label>
            <input type="file" (change)="onNewClientFile($event, 'header')" accept="image/*" />
            @if (newHeaderFile) {
            <div class="mt-2 text-xs">Selected: {{ newHeaderFile.name }}</div>
            }
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Footer</label>
            <input type="file" (change)="onNewClientFile($event, 'footer')" accept="image/*" />
            @if (newFooterFile) {
            <div class="mt-2 text-xs">Selected: {{ newFooterFile.name }}</div>
            }
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Signature</label>
            <input type="file" (change)="onNewClientFile($event, 'signature')" accept="image/*" />
            @if (newSignatureFile) {
            <div class="mt-2 text-xs">Selected: {{ newSignatureFile.name }}</div>
            }
          </div>
        </div>



        <!-- Created client uploaded assets (explicit slots) -->
        <div class="mt-4">
          <h5 class="font-medium mb-2">Uploaded Assets</h5>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">

            <!-- Logo -->
            <div class="bg-white p-2 rounded shadow text-center">
              <div class="h-24 w-full bg-gray-50 rounded overflow-hidden flex items-center justify-center">
                @if (getCreatedAssetByType('logo')) {
                <img [src]="getCreatedAssetByType('logo')!.url" [alt]="getCreatedAssetByType('logo')!.name"
                  class="h-full object-contain" />
                } @else {
                <div class="text-xs text-gray-400">No logo</div>
                }
              </div>
              <div class="mt-2 text-xs text-gray-600">Logo · {{ getCreatedAssetByType('logo')?.name || '—' }}</div>
              <div class="mt-2 flex gap-2 justify-center">
                <label class="px-2 py-1 bg-gray-100 rounded cursor-pointer text-sm">
                  Change
                  <input type="file" (change)="onEditAssetFile($event,'logo')" accept="image/*" class="hidden" />
                </label>
                @if (getCreatedAssetByType('logo')) { <button
                  (click)="deleteCreatedAsset(getCreatedAssetByType('logo')!)"
                  class="px-2 py-1 text-red-600 text-sm">Delete</button> }
              </div>
            </div>

            <!-- Header -->
            <div class="bg-white p-2 rounded shadow text-center">
              <div class="h-24 w-full bg-gray-50 rounded overflow-hidden flex items-center justify-center">
                @if (getCreatedAssetByType('header')) {
                <img [src]="getCreatedAssetByType('header')!.url" [alt]="getCreatedAssetByType('header')!.name"
                  class="h-full object-contain" />
                } @else {
                <div class="text-xs text-gray-400">No header</div>
                }
              </div>
              <div class="mt-2 text-xs text-gray-600">Header · {{ getCreatedAssetByType('header')?.name || '—' }}</div>
              <div class="mt-2 flex gap-2 justify-center">
                <label class="px-2 py-1 bg-gray-100 rounded cursor-pointer text-sm">
                  Change
                  <input type="file" (change)="onEditAssetFile($event,'header')" accept="image/*" class="hidden" />
                </label>
                @if (getCreatedAssetByType('header')) { <button
                  (click)="deleteCreatedAsset(getCreatedAssetByType('header')!)"
                  class="px-2 py-1 text-red-600 text-sm">Delete</button> }
              </div>
            </div>

            <!-- Footer -->
            <div class="bg-white p-2 rounded shadow text-center">
              <div class="h-24 w-full bg-gray-50 rounded overflow-hidden flex items-center justify-center">
                @if (getCreatedAssetByType('footer')) {
                <img [src]="getCreatedAssetByType('footer')!.url" [alt]="getCreatedAssetByType('footer')!.name"
                  class="h-full object-contain" />
                } @else {
                <div class="text-xs text-gray-400">No footer</div>
                }
              </div>
              <div class="mt-2 text-xs text-gray-600">Footer · {{ getCreatedAssetByType('footer')?.name || '—' }}</div>
              <div class="mt-2 flex gap-2 justify-center">
                <label class="px-2 py-1 bg-gray-100 rounded cursor-pointer text-sm">
                  Change
                  <input type="file" (change)="onEditAssetFile($event,'footer')" accept="image/*" class="hidden" />
                </label>
                @if (getCreatedAssetByType('footer')) { <button
                  (click)="deleteCreatedAsset(getCreatedAssetByType('footer')!)"
                  class="px-2 py-1 text-red-600 text-sm">Delete</button> }
              </div>
            </div>

            <!-- Signature -->
            <div class="bg-white p-2 rounded shadow text-center">
              <div class="h-24 w-full bg-gray-50 rounded overflow-hidden flex items-center justify-center">
                @if (getCreatedAssetByType('signature')) {
                <img [src]="getCreatedAssetByType('signature')!.url" [alt]="getCreatedAssetByType('signature')!.name"
                  class="h-full object-contain" />
                } @else {
                <div class="text-xs text-gray-400">No signature</div>
                }
              </div>
              <div class="mt-2 text-xs text-gray-600">Signature · {{ getCreatedAssetByType('signature')?.name || '—' }}
              </div>
              <div class="mt-2 flex gap-2 justify-center">
                <label class="px-2 py-1 bg-gray-100 rounded cursor-pointer text-sm">
                  Change
                  <input type="file" (change)="onEditAssetFile($event,'signature')" accept="image/*" class="hidden" />
                </label>
                @if (getCreatedAssetByType('signature')) { <button
                  (click)="deleteCreatedAsset(getCreatedAssetByType('signature')!)"
                  class="px-2 py-1 text-red-600 text-sm">Delete</button> }
              </div>
            </div>

          </div>
        </div>

        <div class="flex justify-between">
          <div>
            <button (click)="promptCancelCreateFlow()" class="px-3 py-1">Cancel</button>
          </div>
          <div class="flex gap-2">
            <button (click)="newStep = 1" class="px-3 py-1 border rounded">Back</button>
            <button (click)="finishCreateClient()" class="px-3 py-1 bg-green-600 text-white rounded">Finish</button>
          </div>
        </div>
        }

      </div>
    </div>
    }

    <!-- Assets Panel -->
    @if (selectedClient) {
    <div class="mt-3 bg-gray-50 p-4 rounded">
      <!-- Edit Client Inline -->
      <div class="mt-6 bg-white p-4 rounded">
        <h4 class="font-semibold mb-3">Edit Client</h4>
        <!-- Existing uploaded assets (explicit slots) -->
        <div class="mt-4">
          <h5 class="font-medium mb-2">Uploaded Assets</h5>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">

            <!-- Logo -->
            <div class="bg-white p-2 rounded shadow text-center">
              <div class="h-24 w-full bg-gray-50 rounded overflow-hidden flex items-center justify-center">
                @if (getAssetByType('logo')) {
                <img [src]="getAssetByType('logo')!.url" [alt]="getAssetByType('logo')!.name"
                  class="h-full object-contain" />
                } @else {
                <div class="text-xs text-gray-400">No logo</div>
                }
              </div>
              <div class="mt-2 text-xs text-gray-600">Logo · {{ getAssetByType('logo')?.name || '—' }}</div>
              <div class="mt-2 flex gap-2 justify-center">
                <label class="px-2 py-1 bg-gray-100 rounded cursor-pointer text-sm">
                  Change
                  <input type="file" (change)="onEditAssetFile($event,'logo')" accept="image/*" class="hidden" />
                </label>
                @if (getAssetByType('logo')) { <button (click)="promptDeleteAsset(getAssetByType('logo')!)"
                  class="px-2 py-1 text-red-600 text-sm">Delete</button> }
              </div>
            </div>

            <!-- Header -->
            <div class="bg-white p-2 rounded shadow text-center">
              <div class="h-24 w-full bg-gray-50 rounded overflow-hidden flex items-center justify-center">
                @if (getAssetByType('header')) {
                <img [src]="getAssetByType('header')!.url" [alt]="getAssetByType('header')!.name"
                  class="h-full object-contain" />
                } @else {
                <div class="text-xs text-gray-400">No header</div>
                }
              </div>
              <div class="mt-2 text-xs text-gray-600">Header · {{ getAssetByType('header')?.name || '—' }}</div>
              <div class="mt-2 flex gap-2 justify-center">
                <label class="px-2 py-1 bg-gray-100 rounded cursor-pointer text-sm">
                  Change
                  <input type="file" (change)="onEditAssetFile($event,'header')" accept="image/*" class="hidden" />
                </label>
                @if (getAssetByType('header')) { <button (click)="promptDeleteAsset(getAssetByType('header')!)"
                  class="px-2 py-1 text-red-600 text-sm">Delete</button> }
              </div>
            </div>

            <!-- Footer -->
            <div class="bg-white p-2 rounded shadow text-center">
              <div class="h-24 w-full bg-gray-50 rounded overflow-hidden flex items-center justify-center">
                @if (getAssetByType('footer')) {
                <img [src]="getAssetByType('footer')!.url" [alt]="getAssetByType('footer')!.name"
                  class="h-full object-contain" />
                } @else {
                <div class="text-xs text-gray-400">No footer</div>
                }
              </div>
              <div class="mt-2 text-xs text-gray-600">Footer · {{ getAssetByType('footer')?.name || '—' }}</div>
              <div class="mt-2 flex gap-2 justify-center">
                <label class="px-2 py-1 bg-gray-100 rounded cursor-pointer text-sm">
                  Change
                  <input type="file" (change)="onEditAssetFile($event,'footer')" accept="image/*" class="hidden" />
                </label>
                @if (getAssetByType('footer')) { <button (click)="promptDeleteAsset(getAssetByType('footer')!)"
                  class="px-2 py-1 text-red-600 text-sm">Delete</button> }
              </div>
            </div>

            <!-- Signature -->
            <div class="bg-white p-2 rounded shadow text-center">
              <div class="h-24 w-full bg-gray-50 rounded overflow-hidden flex items-center justify-center">
                @if (getAssetByType('signature')) {
                <img [src]="getAssetByType('signature')!.url" [alt]="getAssetByType('signature')!.name"
                  class="h-full object-contain" />
                } @else {
                <div class="text-xs text-gray-400">No signature</div>
                }
              </div>
              <div class="mt-2 text-xs text-gray-600">Signature · {{ getAssetByType('signature')?.name || '—' }}</div>
              <div class="mt-2 flex gap-2 justify-center">
                <label class="px-2 py-1 bg-gray-100 rounded cursor-pointer text-sm">
                  Change
                  <input type="file" (change)="onEditAssetFile($event,'signature')" accept="image/*" class="hidden" />
                </label>
                @if (getAssetByType('signature')) { <button (click)="promptDeleteAsset(getAssetByType('signature')!)"
                  class="px-2 py-1 text-red-600 text-sm">Delete</button> }
              </div>
            </div>

          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <input [(ngModel)]="selectedClient.name" class="p-2 border rounded" />
          <input [(ngModel)]="selectedClient.contact_email" class="p-2 border rounded" placeholder="Contact Email" />
          <input [(ngModel)]="selectedClient.contact_phone" class="p-2 border rounded" placeholder="Contact Phone" />
          <input [(ngModel)]="selectedClient.address" class="p-2 border rounded" placeholder="Address" />
          <input [(ngModel)]="selectedClient.city" class="p-2 border rounded" placeholder="City" />
          <input [(ngModel)]="selectedClient.state" class="p-2 border rounded" placeholder="State" />
          <input [(ngModel)]="selectedClient.zipCode" class="p-2 border rounded" placeholder="ZIP Code" />
          <input [(ngModel)]="selectedClient.website" class="p-2 border rounded" placeholder="Website" />
        </div>

        <div class="mt-3 grid grid-cols-2 gap-4">
          <input [(ngModel)]="selectedClient.logo" class="p-2 border rounded" placeholder="Logo URL" />
          <input [(ngModel)]="selectedClient.header" class="p-2 border rounded" placeholder="Header URL" />
          <input [(ngModel)]="selectedClient.footer" class="p-2 border rounded" placeholder="Footer URL" />
          <input [(ngModel)]="selectedClient.signature" class="p-2 border rounded" placeholder="Signature URL" />
        </div>

        <div class="mt-4">
          <h5 class="font-medium">Metadata</h5>
          <div *ngFor="let key of metadataKeys()" class="flex gap-2 mt-2">
            <input [(ngModel)]="metaPairs[key].key" disabled class="p-2 border rounded w-40" />
            <input [(ngModel)]="metaPairs[key].value" class="p-2 border rounded flex-1" />
            <button (click)="removeMeta(key)" class="text-red-600 px-2">Delete</button>
          </div>
          <div class="mt-2 flex gap-2">
            <input [(ngModel)]="newMetaKey" placeholder="Key" class="p-2 border rounded w-40" />
            <input [(ngModel)]="newMetaValue" placeholder="Value" class="p-2 border rounded flex-1" />
            <button (click)="addMeta()" class="px-3 py-1 bg-blue-600 text-white rounded">Add</button>
          </div>
        </div>

        <div class="mt-4 flex justify-end gap-2">
          <button (click)="saveClientChanges()" class="px-3 py-1 bg-green-600 text-white rounded">Save</button>
        </div>
      </div>
    </div>
    }

  </main>
</div>